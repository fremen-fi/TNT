name: Build Linux Release
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.1.0)'
        required: true
        default: 'v1.1.0'

jobs:
  build-amd64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag }}

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Install Linux Dependencies
      run: |
        sudo apt-get update
        # Install necessary packages for GLFW/OpenGL (go-gl) dependencies, plus dpkg-dev for .deb creation
        sudo apt-get install -y \
          libgl-dev \
          libx11-dev \
          libxcursor-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxi-dev \
          libxxf86vm-dev \
          dpkg-dev
        
    - name: Download build assets
      run: |
        mkdir -p buildBlocks ffmpegSource
        curl -o buildBlocks/Wotfard-Regular.ttf "https://software.collinsgroup.fi/buildBlocks/Wotfard-Regular.ttf?value=3ivfiLlvQ6EB2UyHVqIDc5QA"
        curl -o buildBlocks/tntAppLogoForDark.png "https://software.collinsgroup.fi/buildBlocks/tntAppLogoForDark.png?value=3ivfiLlvQ6EB2UyHVqIDc5QA"
        curl -o buildBlocks/tntAppLogoForLight.png "https://software.collinsgroup.fi/buildBlocks/tntAppLogoForLight.png?value=3ivfiLlvQ6EB2UyHVqIDc5QA"
        curl -o ffmpegSource/ffmpegLinuxAmd64 "https://software.collinsgroup.fi/buildBlocks/ffmpeg/ffmpegLinuxAmd64?value=3ivfiLlvQ6EB2UyHVqIDc5QA"

    - name: Build
      run: CGO_ENABLED=1 go build -o tnt-linux-amd64

    - name: Create Desktop Entry File
      run: |
        # Creates the tnt.desktop file on the runner's disk
        cat << EOF > tnt.desktop
[Desktop Entry]
Name=TNT App
Comment=A description of what your application does.
Exec=/opt/tnt/tnt-linux-amd64
Icon=/opt/tnt/tntAppLogoForDark.png
Terminal=false
Type=Application
Categories=Utility;Graphics;
StartupNotify=true
EOF

    - name: Create .deb Package
      run: |
        TAG_NAME="${{ github.event.inputs.tag }}"
        # Extract version without 'v' prefix for Debian package versioning (e.g., v1.1.0 -> 1.1.0)
        VERSION_PART="${TAG_NAME/v/}" 
        PACKAGE_NAME="tnt-app"
        DEB_DIR="$PACKAGE_NAME-package"
        DEB_FILE_NAME="${PACKAGE_NAME}_${VERSION_PART}_amd64.deb"

        # 1. Setup the directory structure
        mkdir -p $DEB_DIR/DEBIAN
        mkdir -p $DEB_DIR/opt/tnt
        mkdir -p $DEB_DIR/usr/share/applications

        # 2. Create the control file with updated metadata
        # Dependencies listed here match the libs installed by the workflow
        cat << EOF > $DEB_DIR/DEBIAN/control
Package: $PACKAGE_NAME
Version: $VERSION_PART
Section: utils
Priority: optional
Architecture: amd64
Maintainer: Collins Group <appsupport@collinsgroup.fi>
Description: TNT Plus
Depends: libgl1-mesa-dev, libx11-6, libxcursor1, libxrandr2, libxinerama1, libxi6, libxxf86vm1
EOF

        # 3. Create the post-installation script
        cat << EOF > $DEB_DIR/DEBIAN/postinst
#!/bin/bash
# Set execute permission on the executable
chmod +x /opt/tnt/tnt-linux-amd64
# Update the desktop file database (ensures app appears in menu instantly)
update-desktop-database
exit 0
EOF
        # Make postinst executable
        chmod 0755 $DEB_DIR/DEBIAN/postinst

        # 4. Move the built executable, icon, and .desktop file into the structure
        mv tnt-linux-amd64 $DEB_DIR/opt/tnt/
        
        # Copy icon from downloaded assets (used by the desktop file)
        cp buildBlocks/tntAppLogoForDark.png $DEB_DIR/opt/tnt/

        # Copy the .desktop file from the repo root (now successfully created above)
        cp tnt.desktop $DEB_DIR/usr/share/applications/

        # 5. Build the .deb package
        dpkg-deb --build $DEB_DIR $DEB_FILE_NAME
        
        # Export the filename to be used by subsequent steps
        echo "DEB_FILE_NAME=$DEB_FILE_NAME" >> $GITHUB_ENV

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: tnt-linux-deb-package
        path: ${{ env.DEB_FILE_NAME }}
        
    - name: Upload to BunnyCDN
      run: |
        curl -X PUT \
          -H "AccessKey: ${{ secrets.BUNNY_ACCESS_KEY }}" \
          --data-binary "@${{ env.DEB_FILE_NAME }}" \
          "https://se.storage.bunnycdn.com/sw-stor/${{ env.DEB_FILE_NAME }}"
