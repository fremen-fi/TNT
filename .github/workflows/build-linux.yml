name: Build Linux Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.1.0)'
        required: true
        default: 'v1.1.0'

jobs:
  build-amd64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag }}

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Download build assets
      run: |
        mkdir -p buildBlocks ffmpegSource
        curl -o buildBlocks/Wotfard-Regular.ttf "https://software.collinsgroup.fi/buildBlocks/Wotfard-Regular.ttf?value=3ivfiLlvQ6EB2UyHVqIDc5QA"
        curl -o buildBlocks/tntAppLogoForDark.png "https://software.collinsgroup.fi/buildBlocks/tntAppLogoForDark.png?value=3ivfiLlvQ6EB2UyHVqIDc5QA"
        curl -o buildBlocks/tntAppLogoForLight.png "https://software.collinsgroup.fi/buildBlocks/tntAppLogoForLight.png?value=3ivfiLlvQ6EB2UyHVqIDc5QA"
        curl -o ffmpegSource/ffmpegLinuxAmd64 "https://software.collinsgroup.fi/buildBlocks/ffmpeg/ffmpegLinuxAmd64?value=3ivfiLlvQ6EB2UyHVqIDc5QA"
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev xorg-dev

    - name: Build
      run: go build -o tnt-linux-amd64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: tnt-linux-amd64
        path: tnt-linux-amd64
        
    - name: Create .desktop file
      run: |
        cat > tnt.desktop << 'DESKTOP_EOF'
        [Desktop Entry]
        Name=TNT
        Comment=Professional audio processing tool
        Exec=/usr/bin/tnt
        Icon=tnt
        Terminal=false
        Type=Application
        Categories=Audio;AudioVideo;
        DESKTOP_EOF

    - name: Create postinst script
      run: |
        cat > postinst << 'POSTINST_EOF'
        #!/bin/bash
        chmod +x /usr/bin/tnt
        update-desktop-database || true
        exit 0
        POSTINST_EOF
        chmod +x postinst

    - name: Build deb package
      run: |
        VERSION="${{ github.event.inputs.tag }}"
        VERSION="${VERSION#v}"
        DEB_DIR="tnt_${VERSION}_amd64"
        
        mkdir -p "${DEB_DIR}/DEBIAN"
        mkdir -p "${DEB_DIR}/usr/bin"
        mkdir -p "${DEB_DIR}/usr/share/applications"
        
        cp tnt-linux-amd64 "${DEB_DIR}/usr/bin/tnt"
        cp tnt.desktop "${DEB_DIR}/usr/share/applications/"
        cp postinst "${DEB_DIR}/DEBIAN/"
        
        cat > "${DEB_DIR}/DEBIAN/control" << 'CONTROL_EOF'
        Package: tnt
        Version: ${VERSION}
        Section: sound
        Priority: optional
        Architecture: amd64
        Maintainer: Collins Group <appsupport@collinsgroup.fi>
        Description: TNT Plus - Professional audio processing tool
         Audio normalization and transcoding tool built for broadcast professionals.
        CONTROL_EOF
        
        sed -i "s/\${VERSION}/${VERSION}/" "${DEB_DIR}/DEBIAN/control"
        
        dpkg-deb --build "${DEB_DIR}"
        echo "DEB_FILE=tnt_${VERSION}_amd64.deb" >> $GITHUB_ENV

    - name: Upload to BunnyCDN
      env:
        BUNNY_ACCESS_KEY: ${{ secrets.BUNNY_ACCESS_KEY }}
      run: |
        curl -X PUT \
          -H "AccessKey: $BUNNY_ACCESS_KEY" \
          --data-binary "@${{ env.DEB_FILE }}" \
          "https://se.storage.bunnycdn.com/sw-stor/${{ env.DEB_FILE }}"
